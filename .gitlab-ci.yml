stages:
  - test
  - build
  - deployStaging

variables:
  AMZ_REGISTRY: 292374005836.dkr.ecr.ap-southeast-2.amazonaws.com
  GITLAB_REGISTRY: registry.gitlab.com/rflett/containers

unitTests:
  stage: test
  image: $GITLAB_REGISTRY/python:latest
  script:
    - cd src/
    - python -m pytest

build:
  stage: build
  image: $GITLAB_REGISTRY/docker:latest
  services:
    - docker:dind
  tags:
    - docker
  script:
    # docker-login to ecr
    - eval $(aws ecr get-login --no-include-email)
    # build, tag, and push commit
    - docker build -t $AMZ_REGISTRY/api:$CI_COMMIT_SHA src/
    - docker push $AMZ_REGISTRY/api:$CI_COMMIT_SHA
    # tag and push latest
    - docker tag $AMZ_REGISTRY/api:$CI_COMMIT_SHA $AMZ_REGISTRY/api:latest
    - docker push $AMZ_REGISTRY/api:latest

deployStaging:
  stage: deployStaging
  image: $GITLAB_REGISTRY/python:latest
  when: manual
  tags:
    - docker
  script:
    - python deploy/deploy.py api staging
